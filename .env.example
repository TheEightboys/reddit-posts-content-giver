# =====================================================
# REDIGEN BACKEND - ENVIRONMENT VARIABLES
# =====================================================
# Copy this file to .env and fill in your actual values
# DO NOT commit .env to git - it contains secrets!

# =====================================================
# SERVER CONFIGURATION
# =====================================================
PORT=3000
NODE_ENV=production

# Frontend URL (for CORS and redirects)
FRONTEND_URL=https://redrule.site

# =====================================================
# SUPABASE DATABASE (REQUIRED)
# =====================================================
# Get these from Supabase Dashboard > Settings > API

# Your Supabase URL
SUPABASE_URL=https://your-project.supabase.co

# Supabase Anon Key (for client-side - public)
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Supabase Service Role Key (KEEP SECRET - for backend only!)
# This has full access to your database
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Service Key (alternative name, same as SERVICE_ROLE_KEY)
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# =====================================================
# GEMINI API (REQUIRED for AI generation)
# =====================================================
# Get your API key from: https://makersuite.google.com/app/apikey
GEMINI_API_KEY=AIzaSyD...

# =====================================================
# DODO PAYMENTS (REQUIRED for payment activation)
# =====================================================
# Get these from Dodo Payments Dashboard

# Dodo API Key (for verifying payments)
# Used in /api/payment/verify to check payment status with Dodo
DODO_API_KEY=sk_test_... or sk_live_...

# Dodo Webhook Secret (for webhook signature verification) - CRITICAL!
# This is the SIGNING SECRET from Dodo Dashboard
# Used to verify that webhook requests actually come from Dodo
# Gets sent in the dodo-signature header on webhook calls
# IMPORTANT: Get this from your Dodo Dashboard under Webhooks section
DODO_WEBHOOK_SECRET=whsec_...

# =====================================================
# NOTES FOR COMPLETE SETUP
# =====================================================
# 
# STEP 1: SUPABASE DATABASE SETUP
# ======================================
# 1. Go to https://supabase.com and create a new project
# 2. Wait for project to be ready
# 3. Go to Settings > API (on the left sidebar)
# 4. Copy:
#    - Project URL → SUPABASE_URL
#    - Anon Key → SUPABASE_ANON_KEY
#    - Service Role Key → SUPABASE_SERVICE_ROLE_KEY
# 5. Go to SQL Editor
# 6. Paste the entire contents of supabase_setup.sql
# 7. Run the SQL to create tables, indexes, and RLS policies
# 8. Verify: Check Tables section shows all 5 tables created
#
# STEP 2: DODO PAYMENTS SETUP
# ======================================
# 1. Go to https://dodopayments.com
# 2. Create account and verify email
# 3. Go to Dashboard > Products
# 4. Create 3 products:
#    - Starter Plan (monthly): $1.29
#    - Starter Plan (yearly): $11.11
#    - Professional Plan (monthly): $2.29
#    - Professional Plan (yearly): $19.22
#    - Enterprise Plan: $29.00
# 5. Note the product IDs - update PRICING_DATA in dashboard.js
# 6. Go to Settings > API Keys
# 7. Copy test or live API key → DODO_API_KEY
# 8. Go to Webhooks
# 9. Create new endpoint with:
#    - URL: https://your-render-url/api/dodo/webhook
#    - Events: checkout.session.completed, payment.succeeded
# 10. Copy the signing secret → DODO_WEBHOOK_SECRET
#
# STEP 3: RENDER BACKEND DEPLOYMENT
# ======================================
# 1. Go to https://render.com
# 2. Create new "Web Service"
# 3. Connect your GitHub repository
# 4. Set build command: npm install
# 5. Set start command: npm start
# 6. Go to Environment section
# 7. Add all variables from this file:
#    - SUPABASE_URL
#    - SUPABASE_SERVICE_ROLE_KEY (or SUPABASE_SERVICE_KEY)
#    - GEMINI_API_KEY
#    - DODO_API_KEY
#    - DODO_WEBHOOK_SECRET
#    - FRONTEND_URL (your domain)
#    - NODE_ENV=production
# 8. Deploy
# 9. Copy the Render URL (e.g., https://reddit-posts-content-giver.onrender.com)
#
# STEP 4: UPDATE WEBHOOK IN DODO
# ======================================
# 1. Go back to Dodo Webhooks
# 2. Update the webhook endpoint with your Render URL:
#    https://your-render-url/api/dodo/webhook
# 3. Save
#
# STEP 5: UPDATE DASHBOARD.JS
# ======================================
# Update these in dashboard.js:
# - API_URL: Point to your Render backend URL
# - SUPABASE_URL: Your project URL
# - SUPABASE_ANON_KEY: Your anon key
# - PRICING_DATA: Update product IDs from Dodo
#
# =====================================================
# TESTING THE PAYMENT FLOW
# =====================================================
#
# 1. WEBHOOK SIGNATURE TEST:
#    curl -X POST https://your-render-url/api/dodo/webhook \
#      -H "dodo-signature: test_sig" \
#      -H "Content-Type: application/json" \
#      -d '{"type":"checkout.session.completed","data":{"object":{"id":"test"}}}'
#
# 2. CHECK RENDER LOGS:
#    - Go to Render Dashboard
#    - Select your service
#    - Check Logs tab for webhook events
#
# 3. CHECK SUPABASE:
#    - Go to Table Editor
#    - Check user_plans for updated status
#    - Check payments for completed transactions
#
# =====================================================
# TROUBLESHOOTING
# =====================================================
#
# Problem: "Plan not activation after payment"
# Solution:
#   1. Check Render logs for webhook receipt
#   2. Verify DODO_WEBHOOK_SECRET is set correctly
#   3. Check supabase_setup.sql was run completely
#   4. Verify payment_records and payments tables exist
#   5. Check RLS policies are enabled
#
# Problem: "Webhook signature invalid"
# Solution:
#   1. Go to Dodo Dashboard > Webhooks
#   2. Copy the exact signing secret
#   3. Paste into DODO_WEBHOOK_SECRET in Render
#   4. Redeploy the service
#
# Problem: "No userId in metadata"
# Solution:
#   1. Check dashboard.js initiateDodoPayment()
#   2. Verify metadata is passed to Dodo checkout
#   3. Check Render logs for full webhook payload
#
# Problem: "Payment verified but plan not active"
# Solution:
#   1. Check user_plans table exists in Supabase
#   2. Verify RLS policies allow service_role INSERT/UPDATE
#   3. Check Render logs for database errors
#   4. Verify SUPABASE_SERVICE_ROLE_KEY is correct
#
